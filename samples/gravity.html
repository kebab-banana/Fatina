<!DOCTYPE html>
<html>
    <head>
	    <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <title>Fatina Sample</title>

        <script src="../build/fatina.js"></script>
        <style>
            .imgTest {
                position: relative;
            }

            hr {
                border-top: 1px dashed #8c8b8b;
	            border-bottom: 1px dashed #fff;
                margin-top: 25px !important;
                clear: both;
            }
        </style>
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootswatch/3.3.7/flatly/bootstrap.min.css">
        <script src="https://cdnjs.cloudflare.com/ajax/libs/pixi.js/4.5.2/pixi.min.js"></script>
    </head>
    <body>
        <div id="canvas1"></div>
        <script>
            var app = new PIXI.Application(1024 / 2, 768 / 2, {backgroundColor : 0x0c243c});
            document.getElementById('canvas1').appendChild(app.view);

            let starTexture = PIXI.Texture.fromImage('star.png')
            let emitter = { x: app.renderer.width / 2, y: app.renderer.height / 2 };

            let counter = 0;
            let delta = 0;
            let move = Fatina.Tween(emitter, ['x'])
                .From({x: app.renderer.width / 2 - 200})
                .To({x: app.renderer.width / 2 + 200}, 5000)
                .OnUpdate((dt, progress) => {
                    delta += dt;
                    if (delta < 700) {
                        return;
                    }
                    delta -= 700;
                    StartAnim(emitter);
                })
                .SetLoop(-1)
                .Start();

            function StartAnim(emit) {
                let destX = emit.x;
                let destY = emit.y;
                let multi = counter % 2 === 0 ? - 1 : 1;
                counter ++;

                let prestar = new PIXI.Sprite(starTexture);
                prestar.anchor.set(0.5);
                prestar.scale.x = 0.2;
                prestar.scale.y = 0.2;
                prestar.x = destX;
                prestar.y = destY + multi * 200;
                prestar.rotation = multi * 12;
                prestar.alpha = 1;
                prestar.tint = 0xf4ee42;

                let appear = Fatina.Tween(prestar, ['x', 'y', 'rotation'])
                    .To({ x: destX, y: destY, rotation: 0}, 900)
                    .SetEasing('outQuad')
                    .OnUpdate((dt, progress) => {
                        appear.Modify({ x: 5 - progress * 5 }, false);
                    })
                    .OnComplete(() => {
                        for (let i=0; i<20; i++) {
                            CreateStar(multi, destX, destY);
                        }
                        setTimeout(() => prestar.destroy(), 50);
                    })
                    .Start();
                app.stage.addChild(prestar);
            }

            function CreateStar(multi, x, y) {
                let star = new PIXI.Sprite(starTexture);
                star.anchor.set(0.5);

                star.x = x;
                star.y = y;
                star.scale.x = 0.2;
                star.scale.y = 0.2;
                star.dy = 0;
                star.alpha = 0;
                star.tint = 0xf4ee42;

                let smoke = Fatina.Tween(star, ['x', 'y', 'rotation'])
                    .SetRelative(true)
                    .To({ x: Math.random() * 300 - 150, y: multi * (Math.random() * 200 + 200), rotation: Math.random() * 12 - 6}, 1600)
                    .OnUpdate((dt) => {
                        star.dy -= multi * dt / 100;
                        smoke.Modify({y: star.dy}, true)
                    })
                    .OnComplete(() => star.destroy());

                let fadeIn = Fatina.Tween(star, ['alpha']).To({ alpha: Math.random() * 0.4 + 0.6 }, 250);
                let fadeOut = Fatina.Tween(star, ['alpha']).To({ alpha: 0 }, 950).SetEasing('outSine');

                let sequence = Fatina.Sequence()
                    .Append(fadeIn)
                    .AppendInterval(4050)
                    .Append(fadeOut)
                    .Join(smoke)
                    .Start();

                app.stage.addChild(star);
            }
        </script>
    </body>
</html>