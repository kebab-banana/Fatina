<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Fatina Sample</title>

    <script src="../../fatina-plugin-animator.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pixi.js/4.5.2/pixi.min.js"></script>
</head>

<body>
    <center>
        <div id="canvas1"></div>
        <div>
            <button class="btn btn-default" onclick="animUnity.Play('run_left')"><<</button>
            <button class="btn btn-default" onclick="animUnity.Play('walk_left')"><</button>
            <button class="btn btn-info" onclick="animUnity.Play('idle')">=</button>
            <button class="btn btn-default" onclick="animUnity.Play('walk_right')">></button>
            <button class="btn btn-default" onclick="animUnity.Play('run_right')">>></button>

            <span>&nbsp;</span>
            <span>&nbsp;</span>
            <span>&nbsp;</span>
            <span>&nbsp;</span>

            <button class="btn btn-default" onclick="animYuko.Play('run_left')"><<</button>
            <button class="btn btn-default" onclick="animYuko.Play('walk_left')"><</button>
            <button class="btn btn-info" onclick="animYuko.Play('idle')">=</button>
            <button class="btn btn-default" onclick="animYuko.Play('walk_right')">></button>
            <button class="btn btn-default" onclick="animYuko.Play('run_right')">>></button>

            <br><br>

            <button class="btn btn-primary" onclick="animYuko.Play('fade_in')">FadeIn</button>
            <button class="btn btn-primary" onclick="animYuko.Play('fade_out')">FadeOut</button>
            <button class="btn btn-primary" onclick="animYuko.Play('jump')">Jump</button>

            <button class="btn btn-success" onclick="Fatina.plugin.TickerManager.PauseAll('character')">Pause</button>
            <button class="btn btn-success" onclick="Fatina.plugin.TickerManager.ResumeAll('character')">Resume</button>
            <button class="btn btn-success" onclick="Fatina.plugin.TickerManager.Get('character').SetTimescale(4)">x4</button>
            <button class="btn btn-success" onclick="Fatina.plugin.TickerManager.Get('character').SetTimescale(1)">x1</button>
            <button class="btn btn-success" onclick="Fatina.plugin.TickerManager.Get('character').SetTimescale(0.25)">x0.25</button>
        </div>

        <br><br>
        <a class="btn btn-primary" href="https://github.com/kefniark/Fatina/blob/gh-pages/src/static/animator/index.html" target="_blank">Read the code</a>
    </center>

    <script>
        // Pixi app Initialization
        var app = new PIXI.Application(1024 / 2, 768 / 2, { backgroundColor: 0x0c243c });
        document.getElementById('canvas1').appendChild(app.view);

        PIXI.loader.add("/Fatina/animator/unity.json").add("/Fatina/animator/yuko.json")
            .load(function () {
                CreateUnityCharacter();
                CreateYukoCharacter();
            });

        var animUnity, animYuko;

        // Fatina Initialization and load Animation Plugin
        Fatina.Init();
        Fatina.LoadPlugin(FatinaPluginAnimator.Get());

        // Register a first animation type: Animation Spritesheet
        Fatina.plugin.AnimatorManager.Register('spritesheet', (object, params) => {
            console.log('init Spritesheet Anim', params);

            // Create a tween on a proxy object and use the value to change the sprite
            let proxy = { index: 0 };
            const tween = Fatina.Tween(proxy, ['index'])
                .From({ index: 0 })
                .To({ index: params.number - 1 }, params.duration)
                .OnStart(() => {
                    if (!params.direction) {
                        return;
                    }

                    // Change the orientation based on the direction param
                    object.scale.x = Math.abs(object.scale.x) * params.direction;
                })
                .OnUpdate(() => object.setTexture(params.textures[proxy.index]))
                .SetSteps(params.number - 1);

            // Some animation don't need loop
            if (!params.disableLoop) {
                tween.SetLoop(-1);
            }

            return tween;
        }, 'character');

        // Register a second animation type: Jump (a simple relative move with yoyo=1)
        Fatina.plugin.AnimatorManager.Register('jump', (object, params) => {
            console.log('Instantiate Jump Anim', object.name, object.position, params);
            return Fatina.Tween(object.position, ['y'])
                .SetRelative(true)
                .To({ y: - 70 }, 400)
                .SetEasing('outSine')
                .Yoyo(1)
                .OnStart(() => object.Animator.Play('jump_up'))
        }, 'character');

        // Register a third animation type: Fade
        Fatina.plugin.AnimatorManager.Register('fade', (object, params) => {
            console.log('Instantiate Fade Anim', params);
            return Fatina.Tween(object, ['alpha']).To({ alpha: params.value }, params.duration)
        }, 'character');


        // Game code, let's create a characters with animation
        function CreateYukoCharacter() {

            // Create a normal Pixi Sprite
            let yukochan = new PIXI.Sprite(PIXI.TextureCache['Yuko_Idle_1']);
            yukochan.name = "Yuko";
            yukochan.anchor.set(0.5);
            yukochan.scale.x = 1.4;
            yukochan.scale.y = 1.4;
            yukochan.x = app.renderer.width / 2 + 50;
            yukochan.y = app.renderer.height / 2;
            app.stage.addChild(yukochan);

            // Let's add a animator component to that sprite and add (instantiate) reusable animations (idle, walk, jump, ...)
            let anim = Fatina.plugin.AnimatorManager.AddAnimatorTo(yukochan)

                // First Group of Animation: Sprite 
                .AddAnimation('idle', 'spritesheet', { group: 'sprite' }, { number: 4, duration: 1000, textures: GetTextures('Yuko_Idle_') })
                .AddAnimation('walk_right', 'spritesheet', { group: 'sprite' }, { direction: 1, number: 6, duration: 1000, textures: GetTextures('Yuko_Walk_') })
                .AddAnimation('run_right', 'spritesheet', { group: 'sprite' }, { direction: 1, number: 8, duration: 1000, textures: GetTextures('Yuko_Run_') })
                .AddAnimation('walk_left', 'spritesheet', { group: 'sprite' }, { direction: -1, number: 6, duration: 1000, textures: GetTextures('Yuko_Walk_') })
                .AddAnimation('run_left', 'spritesheet', { group: 'sprite' }, { direction: -1, number: 8, duration: 1000, textures: GetTextures('Yuko_Run_') })
                .AddAnimation('jump_fall', 'spritesheet', { group: 'sprite', unstoppable: true }, { disableLoop: true, number: 3, duration: 240, textures: GetTextures('Yuko_Jump_Fall_') })
                .AddAnimation('jump_landing', 'spritesheet', { group: 'sprite', unstoppable: true }, { disableLoop: true, number: 1, duration: 80, textures: GetTextures('Yuko_Jump_Landing') })
                .AddAnimation('jump_midair', 'spritesheet', { group: 'sprite', unstoppable: true }, { disableLoop: true, number: 4, duration: 320, textures: GetTextures('Yuko_Jump_MidAir_') })
                .AddAnimation('jump_up', 'spritesheet', { group: 'sprite', unstoppable: true }, { disableLoop: true, number: 2, duration: 160, textures: GetTextures('Yuko_Jump_Up_') })

                // Second Group of Animation: Alpha
                .AddAnimation('fade_in', 'fade', { group: 'alpha', finalValue: true }, { value: 1, duration: 800 })
                .AddAnimation('fade_out', 'fade', { group: 'alpha', finalValue: true }, { value: 0, duration: 800 })

                // Third Group of Animation: Jump (defined as unstoppable)
                .AddAnimation('jump', 'jump', { group: 'move', unstoppable: true })

                // Automatic Transition (at the end of one state, autostart the next one)
                .AddTransition('jump_up', 'jump_midair')
                .AddTransition('jump_midair', 'jump_fall')
                .AddTransition('jump_fall', 'jump_landing')
                .AddTransition('jump_landing', 'idle');

            // Play the default state: idle
            anim.Play('idle');
            animYuko = anim;
        }

        // Game code, let's create a second character with almost the same animation, just different sprites
        function CreateUnityCharacter() {

            // Create a normal Pixi Sprite
            let tokochan = new PIXI.Sprite(PIXI.TextureCache['Unitychan_Idle_1']);
            tokochan.name = "Toko";
            tokochan.anchor.set(0.5);
            tokochan.scale.x = 1.4;
            tokochan.scale.y = 1.4;
            tokochan.x = app.renderer.width / 2 - 50;
            tokochan.y = app.renderer.height / 2;
            app.stage.addChild(tokochan);

            // As you can see bellow, it's exactly the same code, just the array of texture is different
            let anim = Fatina.plugin.AnimatorManager.AddAnimatorTo(tokochan)
                .AddAnimation('idle', 'spritesheet', { group: 'sprite' }, { number: 4, duration: 1000, textures: GetTextures('Unitychan_Idle_') })
                .AddAnimation('walk_right', 'spritesheet', { group: 'sprite' }, { direction: 1, number: 14, duration: 2000, textures: GetTextures('Unitychan_Walk_') })
                .AddAnimation('run_right', 'spritesheet', { group: 'sprite' }, { direction: 1, number: 18, duration: 2000, textures: GetTextures('Unitychan_Run_') })
                .AddAnimation('walk_left', 'spritesheet', { group: 'sprite' }, { direction: -1, number: 14, duration: 2000, textures: GetTextures('Unitychan_Walk_') })
                .AddAnimation('run_left', 'spritesheet', { group: 'sprite' }, { direction: -1, number: 18, duration: 2000, textures: GetTextures('Unitychan_Run_') });

             // Play the default state: idle
            anim.Play('idle');
            animUnity = anim;
        }

        function GetTextureId(a, name) {
            return parseInt(a.replace(name, ""), 10);
        }

        function GetTextures(name) {
            return Object.keys(PIXI.TextureCache).filter(x => x.indexOf(name) !== -1).sort((a, b) => GetTextureId(a, name) - GetTextureId(b, name)).map(x => PIXI.TextureCache[x])
        }
    </script>
</body>
</html>