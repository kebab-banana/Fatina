<!DOCTYPE html>
<html>
    <head>
	    <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <title>Fatina Sample</title>

        <script src="../build/fatina.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/pixi.js/4.5.2/pixi.min.js"></script>
    </head>
    <body>
        <div id="canvas1"></div>
        <script>
            var app = new PIXI.Application(1024 / 2, 768 / 2, {backgroundColor : 0x0c243c});
            document.getElementById('canvas1').appendChild(app.view);

            Fatina.Init();
            Fatina.LoadPlugin(Fatina.GetPlugin());

            PIXI.loader.add("unity.json").add("yuko.json")
                .load(function() {
                    CreateUnityCharacter();
                    CreateYukoCharacter();
                });

            // Animation Spritesheet
            Fatina.plugin.AnimatorManager.Register('spritesheet', (object, params) => {
                let proxy = { index: 0 };
                console.log('init Spritesheet Anim', params);
                const tween = Fatina.Tween(proxy, ['index'])
                    .From({index: 0 })
                    .To({index: params.number - 1}, params.duration)
                    .OnStart(() => {
                        if (!params.direction) {
                            return;
                        }
                        object.scale.x = Math.abs(object.scale.x) * params.direction;
                    })
                    .OnUpdate(() => object.setTexture(params.textures[proxy.index]))
                    .SetSteps(params.number - 1);
                if (!params.disableLoop) {
                    tween.SetLoop(-1);
                }
                return tween;
            }, 'character');

            Fatina.plugin.AnimatorManager.Register('jump', (object, params) => {
                console.log('init Jump Anim', object.name, object.position, params);
                return Fatina.Tween(object.position, ['y'])
                    .SetRelative(true)
                    .To({y: - 70}, 400)
                    .SetEasing('outSine')
                    .Yoyo(1)
                    .ToSequence()
                    .PrependCallback(() => object.Animator.Play('jump_up'))
            }, 'character');

            Fatina.plugin.AnimatorManager.Register('fade', (object, params) => {
                console.log('init Fade Anim', params);
                return Fatina.Tween(object, ['alpha']).To({ alpha: params.value}, params.duration)
            }, 'character');

            function GetTextureId(a, name) {
                return parseInt(a.replace(name, ""), 10);
            }

            function GetTextures(name) {
                return Object.keys(PIXI.TextureCache).filter(x => x.indexOf(name) !== -1).sort((a, b) => GetTextureId(a, name) - GetTextureId(b, name)).map(x => PIXI.TextureCache[x])
            }

            function CreateYukoCharacter() {
                let yukochan = new PIXI.Sprite(PIXI.TextureCache['Yuko_Idle_1']);
                yukochan.name = "Yuko";
                yukochan.anchor.set(0.5);
                yukochan.scale.x = 1.4;
                yukochan.scale.y = 1.4;
                yukochan.x = app.renderer.width / 2 + 50;
                yukochan.y = app.renderer.height  / 2;
                app.stage.addChild(yukochan);

                let anim = Fatina.plugin.AnimatorManager.AddAnimatorTo(yukochan)
                    .AddAnimation('idle', 'spritesheet', { group: 'sprite' }, {
                        number: 4,
                        duration: 1000,
                        textures: GetTextures('Yuko_Idle_')
                    })
                    .AddAnimation('walk_right', 'spritesheet', { group: 'sprite' }, {
                        direction: 1,
                        number: 6,
                        duration: 1000,
                        textures: GetTextures('Yuko_Walk_')
                    })
                    .AddAnimation('run_right', 'spritesheet', { group: 'sprite' }, {
                        direction: 1,
                        number: 8,
                        duration: 1000,
                        textures: GetTextures('Yuko_Run_')
                    })
                    .AddAnimation('walk_left', 'spritesheet', { group: 'sprite' }, {
                        direction: -1,
                        number: 6,
                        duration: 1000,
                        textures: GetTextures('Yuko_Walk_')
                    })
                    .AddAnimation('run_left', 'spritesheet', { group: 'sprite' }, {
                        direction: -1,
                        number: 8,
                        duration: 1000,
                        textures: GetTextures('Yuko_Run_')
                    })
                    .AddAnimation('jump_fall', 'spritesheet', { group: 'sprite', unstoppable: true }, {
                        disableLoop: true,
                        number: 3,
                        duration: 240,
                        textures: GetTextures('Yuko_Jump_Fall_')
                    })
                    .AddAnimation('jump_landing', 'spritesheet', { group: 'sprite', unstoppable: true }, {
                        disableLoop: true,
                        number: 1,
                        duration: 80,
                        textures: GetTextures('Yuko_Jump_Landing')
                    })
                    .AddAnimation('jump_midair', 'spritesheet', { group: 'sprite', unstoppable: true }, {
                        disableLoop: true,
                        number: 4,
                        duration: 320,
                        textures: GetTextures('Yuko_Jump_MidAir_')
                    })
                    .AddAnimation('jump_up', 'spritesheet', { group: 'sprite', unstoppable: true }, {
                        disableLoop: true,
                        number: 2,
                        duration: 160,
                        textures: GetTextures('Yuko_Jump_Up_')
                    })
                    .AddAnimation('fade_in', 'fade', { group: 'alpha', finalValue: true }, {
                        value: 1,
                        duration: 800
                    })
                    .AddAnimation('fade_out', 'fade', { group: 'alpha', finalValue: true }, {
                        value: 0,
                        duration: 800
                    })
                    .AddAnimation('jump', 'jump', { group: 'move', unstoppable: true })
                    .AddTransition('jump_up', 'jump_midair')
                    .AddTransition('jump_midair', 'jump_fall')
                    .AddTransition('jump_fall', 'jump_landing')
                    .AddTransition('jump_landing', 'idle');

                anim.Play('idle');
                window.yuko = anim;
            }

            function CreateUnityCharacter() {
                let tokochan = new PIXI.Sprite(PIXI.TextureCache['Unitychan_Idle_1']);
                tokochan.name = "Toko";
                tokochan.anchor.set(0.5);
                tokochan.scale.x = 1.4;
                tokochan.scale.y = 1.4;
                tokochan.x = app.renderer.width / 2 - 50;
                tokochan.y = app.renderer.height  / 2;
                app.stage.addChild(tokochan);

                let anim = Fatina.plugin.AnimatorManager.AddAnimatorTo(tokochan)
                    .AddAnimation('idle', 'spritesheet', { group: 'sprite' }, {
                        number: 4,
                        duration: 1000,
                        textures: GetTextures('Unitychan_Idle_')
                    })
                    .AddAnimation('walk_right', 'spritesheet', { group: 'sprite' }, {
                        direction: 1,
                        number: 14,
                        duration: 2000,
                        textures: GetTextures('Unitychan_Walk_')
                    })
                    .AddAnimation('run_right', 'spritesheet', { group: 'sprite' }, {
                        direction: 1,
                        number: 18,
                        duration: 2000,
                        textures: GetTextures('Unitychan_Run_')
                    })
                    .AddAnimation('walk_left', 'spritesheet', { group: 'sprite' }, {
                        direction: -1,
                        number: 14,
                        duration: 2000,
                        textures: GetTextures('Unitychan_Walk_')
                    })
                    .AddAnimation('run_left', 'spritesheet', { group: 'sprite' }, {
                        direction: -1,
                        number: 18,
                        duration: 2000,
                        textures: GetTextures('Unitychan_Run_')
                    });

                // anim.Play('idle');
                window.unity = anim;
            }
        </script>

        <div style="text-align: center">
            <button onclick="window.unity.Play('run_left')"><<</button>
            <button onclick="window.unity.Play('walk_left')"><</button>
            <button onclick="window.unity.Play('idle')">=</button>
            <button onclick="window.unity.Play('walk_right')">></button>
            <button onclick="window.unity.Play('run_right')">>></button>

            ||

            <button onclick="window.yuko.Play('run_left')"><<</button>
            <button onclick="window.yuko.Play('walk_left')"><</button>
            <button onclick="window.yuko.Play('idle')">=</button>
            <button onclick="window.yuko.Play('walk_right')">></button>
            <button onclick="window.yuko.Play('run_right')">>></button>

            <br>
            <button onclick="window.yuko.Play('fade_in')">fadeIn</button>
            <button onclick="window.yuko.Play('fade_out')">fadeOut</button>
            <button onclick="window.yuko.Play('jump')">jump</button>
            <button onclick="Fatina.plugin.TickerManager.PauseAll('character')">Pause</button>
            <button onclick="Fatina.plugin.TickerManager.ResumeAll('character')">Resume</button>
            <button onclick="Fatina.plugin.TickerManager.Get('character').SetTimescale(4)">x4</button>
            <button onclick="Fatina.plugin.TickerManager.Get('character').SetTimescale(1)">x1</button>
            <button onclick="Fatina.plugin.TickerManager.Get('character').SetTimescale(0.25)">x0.25</button>
        </div>
    </body>
</html>